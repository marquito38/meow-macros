<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#f472b6">
    <title>Meow Macros 2.0</title>
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' x='10' font-size='80'>üê±</text></svg>">
    
    <!-- CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap');
        
        body { 
            font-family: 'Nunito', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            background-color: #FFF0F5; /* Lavender Blush */
            background-image: radial-gradient(#fbcfe8 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Animations */
        @keyframes swat {
            0% { transform: translateX(120%) rotate(45deg); opacity: 0; }
            50% { transform: translateX(0) rotate(0deg); opacity: 1; }
            100% { transform: translateX(-50px) rotate(-10deg); opacity: 0; }
        }
        .animate-swat { animation: swat 1s ease-in-out forwards; }

        @keyframes pop-in {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop { animation: pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        /* Mobile safe area padding */
        .safe-pb {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- CONSTANTS ---
        const GOALS = { calories: 1645, carbs: 160, protein: 150, fat: 45, fiber: 38 };
        const USER_WEIGHT_KG = 73; 
        const LIFTING_MET = 6.0;
        const BASE_BMR = 1600;

        const WORKOUTS = {
            A: {
                name: "Workout A (Push)",
                exercises: [
                    { name: "DB Incline Bench", sets: 3 },
                    { name: "DB Goblet Squats", sets: 3 },
                    { name: "FT Lateral Raises", sets: 4 },
                    { name: "FT Tricep Ext", sets: 3 },
                    { name: "Jump Rope HIIT", sets: 1 }
                ]
            },
            B: {
                name: "Workout B (Pull)",
                exercises: [
                    { name: "DB Romanian DL", sets: 3 },
                    { name: "FT Row/Pulldown", sets: 3 },
                    { name: "DB Rear Delt Fly", sets: 3 },
                    { name: "DB Bicep Curls", sets: 3 },
                    { name: "Bike HIIT", sets: 1 }
                ]
            }
        };

        const STARTER_LIBRARY = [
            { id: '1', name: 'Egg Whites', carbs: 0, protein: 11.7, fat: 0, fiber: 0, measure: 'g', baseWeight: 100 },
            { id: '2', name: 'Greek Yogurt', carbs: 3.5, protein: 9.4, fat: 0, fiber: 0, measure: 'g', baseWeight: 100 },
            { id: '3', name: 'Banana', carbs: 23, protein: 1, fat: 0.3, fiber: 2.6, measure: 'g', baseWeight: 100 },
            { id: '4', name: 'Whole Egg', carbs: 0.6, protein: 6, fat: 5, fiber: 0, measure: 'unit', baseWeight: 1 }, 
            { id: '5', name: 'Salmon (Raw)', carbs: 0, protein: 22, fat: 12, fiber: 0, measure: 'g', baseWeight: 100 },
            { id: '6', name: 'Garbanzo Beans', carbs: 17, protein: 5, fat: 1.5, fiber: 5, measure: 'g', baseWeight: 100 }, 
            { id: '7', name: 'Corn', carbs: 7, protein: 0.8, fat: 0.4, fiber: 2, measure: 'g', baseWeight: 100 }, 
            { id: '8', name: 'Mixed Berries', carbs: 9, protein: 0.5, fat: 0, fiber: 3, measure: 'g', baseWeight: 100 },
            { id: '9', name: 'Avocado', carbs: 8.5, protein: 2, fat: 14.7, fiber: 6.7, measure: 'g', baseWeight: 100 },
            { id: '10', name: 'Chicken Breast', carbs: 0, protein: 31, fat: 3.6, fiber: 0, measure: 'g', baseWeight: 100 }
        ];

        const MOTIVATION_QUOTES = ["Crushed it! üêæ", "Paws-itively Strong! üí™", "Feline ferocious today! ü¶Å", "You're the cat's pajamas! üòª", "Purr-fect Performance! ‚≠ê"];

        // --- HELPERS ---
        const calcCals = (c, p, f) => Math.round((c * 4) + (p * 4) + (f * 9));

        const getFoodEmoji = (name) => {
            const n = name.toLowerCase();
            if (n.includes('egg')) return 'ü•ö';
            if (n.includes('banana')) return 'üçå';
            if (n.includes('yogurt')) return 'ü•£';
            if (n.includes('salmon') || n.includes('fish')) return 'üêü';
            if (n.includes('chicken') || n.includes('turkey')) return 'üçó';
            if (n.includes('avocado')) return 'ü•ë';
            if (n.includes('berry')) return 'üçì';
            return 'ü•ó';
        };

        const getVolumeAnimal = (vol) => {
            if(vol > 300000) return "a Blue Whale üêã";
            if(vol > 15000) return "a T-Rex ü¶ñ";
            if(vol > 6000) return "an Elephant üêò";
            if(vol > 4000) return "a Car üöó";
            if(vol > 500) return "a Tiger üêÖ";
            return "a Piano üéπ";
        };

        // --- COMPONENTS ---
        const CatGif = ({ type, className }) => {
            const [error, setError] = useState(false);
            const gifs = { swat: "https://cataas.com/cat/gif", happy: "https://cataas.com/cat/gif?type=medium", sleep: "https://cataas.com/cat/gif?type=small", workout: "https://cataas.com/cat/gif?type=square" };
            const fallbacks = { swat: "üêæ", happy: "üòª", sleep: "üí§", workout: "üèãÔ∏è‚Äç‚ôÄÔ∏è" };
            if (error) return <span className={`flex items-center justify-center text-4xl ${className}`}>{fallbacks[type] || 'üê±'}</span>;
            return <img src={gifs[type]} alt="Cat" className={`object-cover rounded-2xl ${className}`} onError={() => setError(true)} />;
        };

        const CatPawSwat = ({ trigger }) => {
            if (!trigger) return null;
            return <div className="fixed top-1/2 left-0 w-full pointer-events-none z-[60] flex items-center justify-center animate-swat"><CatGif type="swat" className="w-64 h-64 rounded-full shadow-2xl border-4 border-white" /></div>;
        };

        const SuccessModal = ({ isOpen, onClose, title, message, subtext }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[70] bg-black/80 flex items-center justify-center p-6 animate-pop" onClick={onClose}>
                    <div className="text-center text-white w-full max-w-sm" onClick={e => e.stopPropagation()}>
                        <CatGif type="workout" className="w-64 h-64 rounded-full border-4 border-pink-400 mx-auto mb-6 shadow-2xl shadow-pink-500/50" />
                        <h2 className="text-3xl font-black uppercase mb-2 text-pink-300">{title}</h2>
                        <p className="text-xl font-bold italic mb-4">"{message}"</p>
                        {subtext && <div className="bg-white/20 rounded-xl p-4 mb-8">{subtext}</div>}
                        <button onClick={onClose} className="bg-pink-500 text-white w-full py-4 rounded-2xl font-black uppercase shadow-lg active:scale-95 transition-transform">Close</button>
                    </div>
                </div>
            );
        };

        const ProgressBar = ({ current, max, color, label, reverse = false }) => {
            const pct = Math.min(100, Math.max(0, (current / max) * 100));
            const remaining = reverse ? max - current : current;
            const isOver = reverse && current > max;
            const displayVal = isOver ? `${Math.round(current - max)}g over` : `${Math.round(remaining)}g ${reverse ? 'left' : 'done'}`;
            
            return (
                <div className="flex flex-col w-full mb-3">
                    <div className="flex justify-between text-xs font-bold mb-1 text-slate-600 uppercase tracking-wider">
                        <span>{label}</span>
                        <span className={isOver ? 'text-red-500 font-black' : ''}>{displayVal}</span>
                    </div>
                    <div className="h-3 w-full bg-slate-200 rounded-full overflow-hidden">
                        <div className={`h-full transition-all duration-1000 ${color} ${isOver ? 'bg-red-500' : ''}`} style={{ width: `${pct}%` }}></div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            // State
            const [view, setView] = useState('home');
            const [data, setData] = useState({ history: {}, fitnessHistory: {}, library: STARTER_LIBRARY, settings: { apiKey: '' } });
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            
            // UI State
            const [modalOpen, setModalOpen] = useState(false);
            const [finishModalOpen, setFinishModalOpen] = useState(false);
            const [successModalData, setSuccessModalData] = useState(null); 
            const [swatTrigger, setSwatTrigger] = useState(false);
            
            // Food Input
            const [editFood, setEditFood] = useState({ name: '', weight: 100, carbs: 0, protein: 0, fat: 0, fiber: 0, category: 'Snack', measure: 'g' });
            const [librarySearch, setLibrarySearch] = useState('');
            const [isNew, setIsNew] = useState(true);

            // Fitness Input
            const [activeRoutine, setActiveRoutine] = useState('A');
            const [workoutDuration, setWorkoutDuration] = useState(40);
            const [workoutInputs, setWorkoutInputs] = useState({});
            const [timers, setTimers] = useState({});

            // Refs
            const calorieChartRef = useRef(null);
            const volumeChartRef = useRef(null);
            const fileInputRef = useRef(null);
            const timerRef = useRef(null);

            // Init
            useEffect(() => {
                const saved = localStorage.getItem('meow_data_v7'); // Incremented for structure
                if (saved) {
                    const parsed = JSON.parse(saved);
                    if (!parsed.fitnessHistory) parsed.fitnessHistory = {};
                    setData(parsed);
                } else {
                    const old = localStorage.getItem('meow_data_v6');
                    if(old) setData(JSON.parse(old));
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('meow_data_v7', JSON.stringify(data));
            }, [data]);

            // STICKY 0 GLOBAL FIX
            useEffect(() => {
                const applyStickyFix = () => {
                    document.querySelectorAll('input[type="number"]').forEach(input => {
                        input.removeEventListener('focus', handleStickyFocus);
                        input.removeEventListener('blur', handleStickyBlur);
                        input.addEventListener('focus', handleStickyFocus);
                        input.addEventListener('blur', handleStickyBlur);
                    });
                };

                const handleStickyFocus = function() { if (this.value === '0') this.value = ''; };
                const handleStickyBlur = function() { if (this.value === '') this.value = '0'; };

                // Apply on mount and updates
                applyStickyFix();
                // Re-apply when modals open
                const interval = setInterval(applyStickyFix, 500);
                return () => clearInterval(interval);
            }, [modalOpen, finishModalOpen, view]);


            // Timer Loop
            useEffect(() => {
                timerRef.current = setInterval(() => {
                    setTimers(prev => {
                        const next = { ...prev };
                        let changed = false;
                        Object.keys(next).forEach(k => {
                            if (next[k] > 0) { next[k]--; changed = true; }
                        });
                        return changed ? next : prev;
                    });
                }, 1000);
                return () => clearInterval(timerRef.current);
            }, []);

            // Calculations
            const todayLog = data.history[date] || [];
            const todayWorkouts = data.fitnessHistory[date] || [];
            const totals = todayLog.reduce((acc, item) => ({
                c: acc.c + item.c, p: acc.p + item.p, f: acc.f + item.f, fib: acc.fib + item.fib
            }), { c: 0, p: 0, f: 0, fib: 0 });
            
            const totalEatenCals = calcCals(totals.c, totals.p, totals.f);
            const totalBurnedCals = todayWorkouts.reduce((acc, w) => acc + w.calories, 0);
            const adjustedCalorieGoal = GOALS.calories + totalBurnedCals;
            const remainingCals = adjustedCalorieGoal - totalEatenCals;

            // --- HELPERS ---
            const handleFocus = (e, setter) => {
                if (Number(e.target.value) === 0) setter('');
            };

            const formatLastLog = (exName) => {
                const dates = Object.keys(data.fitnessHistory).sort().reverse();
                for (const d of dates) {
                    const sessions = data.fitnessHistory[d];
                    for (const s of sessions) {
                        if (s.exercises && s.exercises[exName]) {
                            const entry = s.exercises[exName];
                            if (Array.isArray(entry)) return "Last: " + entry.map(set => `${set.weight}x${set.reps}`).join(", ");
                            else if (entry.weight) return `Last: ${entry.weight}x${entry.reps}`;
                        }
                    }
                }
                return "Last: --";
            };

            const sortLibrary = (lib) => {
                return [...lib].sort((a, b) => {
                    const aLast = a.lastUsed || 0;
                    const bLast = b.lastUsed || 0;
                    if (bLast !== aLast) return bLast - aLast; // Recent first
                    return a.name.localeCompare(b.name); // Then Alphabetical
                });
            };

            // --- ACTIONS ---
            const handleAddFood = () => {
                // Store EXACTLY what user typed
                const newEntry = {
                    id: Date.now(),
                    name: editFood.name,
                    weight: editFood.weight, 
                    measure: editFood.measure,
                    c: editFood.carbs,
                    p: editFood.protein,
                    f: editFood.fat,
                    fib: editFood.fiber,
                    category: editFood.category
                };

                // Update Library Last Used
                let newLib = [...data.library];
                const existingIdx = newLib.findIndex(i => i.name === editFood.name);
                if (existingIdx >= 0) {
                    newLib[existingIdx] = { ...newLib[existingIdx], lastUsed: Date.now() };
                } else {
                    newLib.push({ ...editFood, id: Date.now().toString(), lastUsed: Date.now() });
                }

                setData({ 
                    ...data, 
                    history: { ...data.history, [date]: [newEntry, ...(data.history[date] || [])] },
                    library: newLib
                });
                
                setModalOpen(false);
                setSwatTrigger(true);
                setTimeout(() => setSwatTrigger(false), 1200);
            };

            const openAddFood = (item = null) => {
                if (item) {
                    // Smart load: Calculate totals based on default base weight if needed
                    // User wants "Actual amount I am eating". 
                    // We'll pre-fill with the base unit values from library as a starting point.
                    setEditFood({ 
                        ...item, 
                        weight: item.measure === 'unit' ? 1 : 100,
                        measure: item.measure || 'g' 
                    });
                    setIsNew(false);
                } else {
                    setEditFood({ name: '', weight: 100, carbs: 0, protein: 0, fat: 0, fiber: 0, category: 'Snack', measure: 'g' });
                    setIsNew(true);
                }
                setModalOpen(true);
            };

            const handleFinishWorkout = () => {
                const duration = parseInt(workoutDuration) || 0;
                const burned = Math.round(LIFTING_MET * USER_WEIGHT_KG * (duration / 60));
                
                const workoutLog = {
                    id: Date.now(),
                    routine: activeRoutine,
                    duration: duration,
                    calories: burned,
                    exercises: JSON.parse(JSON.stringify(workoutInputs))
                };

                setData({ 
                    ...data, 
                    fitnessHistory: { ...data.fitnessHistory, [date]: [workoutLog, ...(data.fitnessHistory[date] || [])] } 
                });
                
                setWorkoutInputs({});
                setFinishModalOpen(false);
                setSuccessModalData({
                    title: "Workout Complete!",
                    message: MOTIVATION_QUOTES[Math.floor(Math.random() * MOTIVATION_QUOTES.length)],
                    subtext: <div className="text-center"><p className="text-sm font-bold uppercase text-pink-200">Calories Burned</p><p className="text-4xl font-black text-white">{burned}</p></div>
                });
            };

            // --- CHARTS ---
            useEffect(() => {
                if (view === 'trends') {
                    if (calorieChartRef.current) calorieChartRef.current.destroy();
                    if (volumeChartRef.current) volumeChartRef.current.destroy();

                    const labels = [];
                    const calsIn = [];
                    const calsOut = [];
                    const volumeData = [];

                    for (let i=6; i>=0; i--) {
                        const d = new Date();
                        d.setDate(d.getDate() - i);
                        const k = d.toISOString().split('T')[0];
                        labels.push(d.toLocaleDateString('en-US', {weekday:'short'}));
                        
                        const log = data.history[k] || [];
                        const fit = data.fitnessHistory[k] || [];
                        const dayIn = log.reduce((s, x) => s + calcCals(x.c,x.p,x.f), 0);
                        const dayBurn = fit.reduce((s, x) => s + x.calories, 0);
                        calsIn.push(dayIn);
                        calsOut.push(BASE_BMR + dayBurn);

                        let dayVol = 0;
                        fit.forEach(sess => {
                            if (sess.exercises) {
                                Object.values(sess.exercises).forEach(sets => {
                                    sets.forEach(s => dayVol += (s.weight || 0) * (s.reps || 0));
                                });
                            }
                        });
                        volumeData.push(dayVol);
                    }

                    calorieChartRef.current = new Chart(document.getElementById('calChart'), {
                        type: 'bar',
                        data: {
                            labels,
                            datasets: [
                                { label: 'In (Food)', data: calsIn, backgroundColor: '#f472b6', borderRadius: 4 },
                                { label: 'Out (BMR+Work)', data: calsOut, backgroundColor: '#60a5fa', borderRadius: 4 }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: false }, y: { beginAtZero: true } } }
                    });

                    volumeChartRef.current = new Chart(document.getElementById('volChart'), {
                        type: 'line',
                        data: {
                            labels,
                            datasets: [{
                                label: 'Volume (lbs)',
                                data: volumeData,
                                borderColor: '#818cf8',
                                backgroundColor: 'rgba(129, 140, 248, 0.2)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
                return () => {
                    if (calorieChartRef.current) calorieChartRef.current.destroy();
                    if (volumeChartRef.current) volumeChartRef.current.destroy();
                };
            }, [view, data]);

            // --- RENDERERS ---

            const renderHome = () => (
                <div className="space-y-6 pb-20 safe-pb">
                    <div className="flex justify-between items-center mb-2">
                        <h1 className="text-2xl font-black text-pink-500 tracking-tight flex items-center gap-2"><span className="text-3xl">üê±</span> Meow Macros</h1>
                    </div>

                    <div className="glass-panel p-5 rounded-3xl shadow-lg border-b-4 border-pink-200 relative overflow-hidden">
                        <div className="flex justify-between items-end mb-4 relative z-10">
                            <div>
                                <h2 className="text-xs font-black text-slate-400 uppercase tracking-widest">Remaining</h2>
                                <p className={`text-3xl font-black ${remainingCals < 0 ? 'text-red-500' : 'text-slate-700'}`}>
                                    {remainingCals} <span className="text-sm text-slate-400">kcal</span>
                                </p>
                                {totalBurnedCals > 0 && <p className="text-[10px] text-emerald-500 font-bold">+{totalBurnedCals} bonus from Meow Muscles!</p>}
                            </div>
                            <div className="w-16 h-16 relative flex items-center justify-center">
                                <svg viewBox="0 0 36 36" className="w-full h-full transform -rotate-90">
                                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#ffe4e6" strokeWidth="4" />
                                    <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#f472b6" strokeWidth="4" strokeDasharray={`${Math.min(100, (totalEatenCals/adjustedCalorieGoal)*100)}, 100`} />
                                </svg>
                                <span className="absolute text-[8px] font-bold text-pink-500">{Math.round((totalEatenCals/adjustedCalorieGoal)*100)}%</span>
                            </div>
                        </div>
                        <ProgressBar current={totals.c} max={GOALS.carbs} color="bg-blue-400" label="Carbs" reverse={true} />
                        <ProgressBar current={totals.p} max={GOALS.protein} color="bg-pink-400" label="Protein" reverse={true} />
                        <ProgressBar current={totals.f} max={GOALS.fat} color="bg-amber-400" label="Fat" reverse={true} />
                        <ProgressBar current={totals.fib} max={GOALS.fiber} color="bg-emerald-400" label="Fiber (38g Goal)" reverse={false} />
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <button onClick={() => openAddFood()} className="bg-teal-500 text-white p-4 rounded-2xl shadow-md font-bold flex flex-col items-center gap-2 active:scale-95 transition-transform"><i data-lucide="plus-circle" className="w-6 h-6"></i> Add Food</button>
                        <button onClick={() => fileInputRef.current.click()} className="bg-indigo-500 text-white p-4 rounded-2xl shadow-md font-bold flex flex-col items-center gap-2 active:scale-95 transition-transform"><i data-lucide="camera" className="w-6 h-6"></i> AI Scan</button>
                        <input type="file" ref={fileInputRef} className="hidden" />
                    </div>

                    <div className="space-y-2">
                        <h3 className="text-sm font-black text-slate-400 uppercase tracking-widest mb-1">Today's Bowl</h3>
                        {todayLog.length === 0 ? (
                            <div className="text-center py-10 opacity-70"><CatGif type="sleep" className="w-32 h-32 mx-auto mb-2 opacity-80" /><p className="text-xs font-bold uppercase text-slate-400">Empty Bowl...</p></div>
                        ) : todayLog.map(item => (
                            <div key={item.id} className="bg-white p-3 rounded-2xl shadow-sm flex justify-between items-center border-l-4 border-teal-400">
                                <div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded font-black uppercase">{item.category}</span>
                                        <p className="font-bold text-slate-700 text-sm">{item.name}</p>
                                    </div>
                                    <p className="text-[10px] text-slate-400 font-bold uppercase mt-0.5">
                                        {item.weight}{item.measure} ‚Ä¢ {Math.round(calcCals(item.c, item.p, item.f))} cal ‚Ä¢ <span className="text-emerald-500">{item.fib.toFixed(1)}g Fib</span>
                                    </p>
                                </div>
                                <button onClick={() => setData({...data, history: {...data.history, [date]: todayLog.filter(i=>i.id!==item.id)}})} className="text-slate-300 hover:text-red-400"><i data-lucide="trash-2" className="w-4 h-4"></i></button>
                            </div>
                        ))}
                    </div>
                </div>
            );

            const renderFitness = () => (
                <div className="pb-24 safe-pb space-y-6">
                    <div className="sticky top-0 bg-[#FFF0F5] z-30 pb-2 pt-2">
                        <h2 className="text-2xl font-black text-slate-700">Meow Muscles Pro üí™</h2>
                        <div className="flex bg-white p-1 rounded-2xl shadow-sm mt-4">
                            {['A', 'B'].map(r => (
                                <button key={r} onClick={() => setActiveRoutine(r)} className={`flex-1 py-3 rounded-xl font-black text-xs uppercase transition-all ${activeRoutine === r ? 'bg-pink-500 text-white shadow-md' : 'text-slate-400'}`}>Workout {r}</button>
                            ))}
                        </div>
                    </div>

                    <div className="space-y-6">
                        {WORKOUTS[activeRoutine].exercises.map((ex, idx) => {
                            const lastSummary = formatLastLog(ex.name);
                            const timeLeft = timers[ex.name] || 0;
                            const currentSets = workoutInputs[ex.name] || Array(ex.sets).fill({weight:0, reps:0, difficulty:'üòº'});
                            
                            return (
                                <div key={idx} className="bg-white p-4 rounded-3xl shadow-sm border border-slate-100">
                                    <div className="flex justify-between items-center mb-3">
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2">
                                                <h3 className="font-bold text-slate-800 text-sm">{ex.name}</h3>
                                                {timeLeft > 0 && <span className="text-xs font-mono text-pink-500 font-bold animate-pulse">{timeLeft}s</span>}
                                            </div>
                                            <p className="text-[10px] font-bold text-slate-400 uppercase truncate max-w-[200px]">{lastSummary}</p>
                                        </div>
                                        <button onClick={() => setTimers(prev => ({...prev, [ex.name]: prev[ex.name]>0 ? 0 : 90}))} className={`px-3 py-1.5 rounded-xl text-[10px] font-black uppercase transition-colors ${timeLeft > 0 ? 'bg-pink-100 text-pink-500' : 'bg-slate-100 text-slate-500'}`}>{timeLeft > 0 ? 'Stop üõë' : 'Cat Nap üò∫'}</button>
                                    </div>

                                    <div className="grid grid-cols-[0.5fr_1fr_1fr_1fr] gap-2 mb-2 px-1 text-center">
                                        <span className="text-[9px] font-black uppercase text-slate-300">Set</span>
                                        <span className="text-[9px] font-black uppercase text-slate-300">Lbs</span>
                                        <span className="text-[9px] font-black uppercase text-slate-300">Reps</span>
                                        <span className="text-[9px] font-black uppercase text-slate-300">Diff</span>
                                    </div>

                                    <div className="space-y-2">
                                        {Array.from({length: ex.sets}).map((_, setIdx) => {
                                            const setData = currentSets[setIdx] || {weight: 0, reps: 0, difficulty: 'üòº'};
                                            const updateSet = (field, val) => {
                                                const newSets = [...currentSets];
                                                while(newSets.length <= setIdx) newSets.push({weight:0, reps:0, difficulty:'üòº'});
                                                newSets[setIdx] = { ...newSets[setIdx], [field]: val };
                                                setWorkoutInputs({ ...workoutInputs, [ex.name]: newSets });
                                            };
                                            return (
                                                <div key={setIdx} className="grid grid-cols-[0.5fr_1fr_1fr_1fr] gap-2 items-center">
                                                    <div className="text-center font-black text-slate-300 text-xs">{setIdx + 1}</div>
                                                    <input type="number" className="bg-slate-50 p-2 rounded-xl text-center font-bold text-sm outline-none focus:ring-1 ring-pink-300" value={setData.weight} onFocus={e => handleFocus(e, v => updateSet('weight', v))} onChange={e => updateSet('weight', Number(e.target.value))} />
                                                    <input type="number" className="bg-slate-50 p-2 rounded-xl text-center font-bold text-sm outline-none focus:ring-1 ring-pink-300" value={setData.reps} onFocus={e => handleFocus(e, v => updateSet('reps', v))} onChange={e => updateSet('reps', Number(e.target.value))} />
                                                    <select className="bg-slate-50 p-2 rounded-xl text-center text-sm appearance-none outline-none" value={setData.difficulty} onChange={e => updateSet('difficulty', e.target.value)}><option>üò∫</option><option>üòº</option><option>üôÄ</option></select>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    {/* Fixed: Removed Duration Input from here */}
                    <button onClick={() => setFinishModalOpen(true)} className="w-full bg-slate-800 text-white py-4 rounded-2xl font-black uppercase shadow-xl hover:bg-slate-900 active:scale-95 transition-transform flex items-center justify-center gap-2 sticky bottom-24 z-20"><i data-lucide="check-circle" className="w-5 h-5"></i> Finish Workout</button>
                </div>
            );

            const renderTrends = () => {
                const pastWorkouts = Object.entries(data.fitnessHistory)
                    .flatMap(([d, logs]) => logs.map(l => ({ date: d, ...l })))
                    .sort((a, b) => b.id - a.id)
                    .slice(0, 10);

                return (
                    <div className="pb-20 safe-pb space-y-6">
                        <h2 className="text-2xl font-black text-slate-700">Trends & History</h2>
                        <div className="bg-white p-4 rounded-3xl shadow-sm h-64">
                            <h3 className="text-xs font-black text-slate-400 uppercase mb-2">Calories: In vs Out</h3>
                            <div className="h-52"><canvas id="calChart"></canvas></div>
                        </div>
                        <div className="bg-white p-4 rounded-3xl shadow-sm h-64">
                            <h3 className="text-xs font-black text-slate-400 uppercase mb-2">Volume Lifted</h3>
                            <div className="h-52"><canvas id="volChart"></canvas></div>
                        </div>
                        <div className="space-y-3">
                            <h3 className="font-bold text-slate-700">Workout Log</h3>
                            {pastWorkouts.length === 0 ? <p className="text-xs text-slate-400">No workouts yet.</p> : pastWorkouts.map(w => {
                                let vol = 0;
                                Object.values(w.exercises || {}).forEach(sets => sets.forEach(s => vol += (s.weight||0)*(s.reps||0)));
                                return (
                                    <div key={w.id} className="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-indigo-400">
                                        <div className="flex justify-between">
                                            <p className="font-bold text-slate-700 text-sm">Workout {w.routine} <span className="text-xs font-normal text-slate-400">({w.date})</span></p>
                                            <p className="text-xs font-bold text-pink-500">{w.calories} cal</p>
                                        </div>
                                        <p className="text-[10px] text-slate-500 mt-1">Total Volume: <span className="font-black">{vol.toLocaleString()} lbs</span></p>
                                        <p className="text-[10px] text-indigo-500 italic">That's heavy! Like {getVolumeAnimal(vol)}</p>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            const renderLibrary = () => (
                <div className="pb-20 safe-pb">
                    <div className="sticky top-0 bg-[#FFF0F5] z-30 pb-4 pt-2">
                        <h2 className="text-2xl font-black text-slate-700 mb-4">Food Library</h2>
                        <div className="relative">
                            <i data-lucide="search" className="absolute left-4 top-3 text-slate-400 w-4 h-4"></i>
                            <input className="w-full bg-white pl-10 pr-4 py-3 rounded-2xl shadow-sm outline-none focus:ring-2 ring-pink-300 font-bold text-sm text-slate-700" placeholder="Search foods..." value={librarySearch} onChange={e => setLibrarySearch(e.target.value)} />
                        </div>
                    </div>
                    <div className="space-y-3">
                        {sortLibrary(data.library.filter(i => i.name.toLowerCase().includes(librarySearch.toLowerCase()))).map(item => (
                            <button key={item.id} onClick={() => openAddFood(item)} className="w-full bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center text-left hover:bg-white/80 transition-colors">
                                <div>
                                    <p className="font-bold text-slate-700">{item.name}</p>
                                    <p className="text-[10px] text-slate-400 uppercase">Per {item.measure === 'unit' ? 'Unit' : '100g'}: C:{Math.round(item.carbs)} P:{Math.round(item.protein)}</p>
                                </div>
                                <div className="bg-slate-100 p-2 rounded-full"><i data-lucide="plus" className="w-4 h-4 text-slate-400"></i></div>
                            </button>
                        ))}
                    </div>
                </div>
            );

            return (
                <div className="max-w-md mx-auto min-h-screen px-4 py-6 relative">
                    <CatPawSwat trigger={swatTrigger} />
                    <SuccessModal isOpen={!!successModalData} onClose={() => setSuccessModalData(null)} {...successModalData} />
                    
                    {/* Views */}
                    {view === 'home' && renderHome()}
                    {view === 'fitness' && renderFitness()}
                    {view === 'library' && renderLibrary()}
                    {view === 'trends' && renderTrends()}
                    {view === 'settings' && <div className="text-center pt-20 text-slate-400">Settings logic preserved in background.</div>}

                    {/* Nav */}
                    <nav className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[95%] max-w-[400px] bg-white/90 backdrop-blur-md border border-white/50 shadow-xl rounded-full p-2 flex justify-around items-center z-40 safe-pb">
                        <button onClick={() => setView('home')} className={`p-3 rounded-full transition-all ${view==='home'?'bg-pink-100 text-pink-500':'text-slate-400'}`}><i data-lucide="home" className="w-5 h-5"></i></button>
                        <button onClick={() => setView('fitness')} className={`p-3 rounded-full transition-all ${view==='fitness'?'bg-pink-100 text-pink-500':'text-slate-400'}`}><i data-lucide="dumbbell" className="w-5 h-5"></i></button>
                        <button onClick={() => setView('library')} className={`p-3 rounded-full transition-all ${view==='library'?'bg-pink-100 text-pink-500':'text-slate-400'}`}><i data-lucide="book" className="w-5 h-5"></i></button>
                        <button onClick={() => setView('trends')} className={`p-3 rounded-full transition-all ${view==='trends'?'bg-pink-100 text-pink-500':'text-slate-400'}`}><i data-lucide="bar-chart-2" className="w-5 h-5"></i></button>
                    </nav>

                    {/* Add Food Modal */}
                    {modalOpen && (
                        <div className="fixed inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-end sm:items-center justify-center p-4" onClick={() => setModalOpen(false)}>
                            <div className="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl animate-in slide-in-from-bottom-10" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-black text-slate-800 uppercase">{isNew ? 'New Entry' : 'Add Food'}</h2>
                                    <button onClick={() => setModalOpen(false)} className="bg-slate-100 w-10 h-10 rounded-full flex items-center justify-center font-bold">&times;</button>
                                </div>
                                <div className="space-y-4 max-h-[70vh] overflow-y-auto no-scrollbar">
                                    {/* Toggle */}
                                    <div className="bg-slate-100 p-1 rounded-xl flex mb-2">
                                        {['g', 'unit'].map(m => (
                                            <button key={m} onClick={() => setEditFood({...editFood, measure: m})} className={`flex-1 py-2 rounded-lg text-xs font-bold uppercase transition-all ${editFood.measure === m ? 'bg-white shadow text-pink-500' : 'text-slate-400'}`}>{m === 'g' ? 'Grams (Weight)' : 'Units (Qty)'}</button>
                                        ))}
                                    </div>
                                    <input className="w-full bg-slate-50 p-4 rounded-2xl font-bold outline-none text-xs" value={editFood.name} onChange={e => setEditFood({...editFood, name: e.target.value})} placeholder="Food Name" />
                                    
                                    <div>
                                        {/* Dynamic Label */}
                                        <label className="text-[10px] font-black uppercase text-slate-400 ml-2">{editFood.measure === 'g' ? 'Weight (g)' : 'Quantity'}</label>
                                        <input type="number" className="w-full bg-slate-50 p-4 rounded-2xl font-bold text-2xl outline-none text-center" value={editFood.weight} onFocus={e => handleFocus(e, v => setEditFood({...editFood, weight: Number(v)}))} onChange={e => setEditFood({...editFood, weight: Number(e.target.value)})} />
                                    </div>

                                    <div className="bg-slate-50 p-4 rounded-3xl border border-slate-100">
                                        {/* Fixed Macro Label */}
                                        <p className="text-[10px] font-black text-center text-slate-400 uppercase mb-3">Macros for this entire entry</p>
                                        <div className="grid grid-cols-4 gap-2">
                                            {['carbs', 'protein', 'fat', 'fiber'].map(m => (
                                                <div key={m}>
                                                    <label className="text-[8px] font-bold uppercase text-slate-400 block text-center mb-1">{m}</label>
                                                    <input type="number" className="w-full p-2 rounded-xl text-center font-bold text-xs" value={editFood[m]} onFocus={e => handleFocus(e, v => setEditFood({...editFood, [m]: Number(v)}))} onChange={e => setEditFood({...editFood, [m]: Number(e.target.value)})} />
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <button onClick={handleAddFood} className="w-full bg-pink-500 text-white py-4 rounded-2xl font-black uppercase shadow-xl hover:bg-pink-600 active:scale-95 transition-transform">Add to Bowl ü•£</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Finish Workout Modal */}
                    {finishModalOpen && (
                        <div className="fixed inset-0 z-50 bg-black/40 backdrop-blur-sm flex items-end sm:items-center justify-center p-4" onClick={() => setFinishModalOpen(false)}>
                            <div className="bg-white w-full max-w-sm rounded-[2rem] p-6 shadow-2xl animate-in slide-in-from-bottom-10" onClick={e => e.stopPropagation()}>
                                <h2 className="text-xl font-black text-slate-800 uppercase mb-6">Almost Done!</h2>
                                {/* Fixed: Duration Input Moved Here */}
                                <div className="mb-6">
                                    <label className="text-[10px] font-black uppercase text-slate-400 ml-1">Total Duration (Minutes)</label>
                                    <input type="number" className="w-full bg-slate-100 p-4 rounded-2xl font-black text-3xl text-center outline-none focus:ring-2 ring-pink-300" value={workoutDuration} onFocus={e => handleFocus(e, setWorkoutDuration)} onChange={e => setWorkoutDuration(e.target.value)} />
                                </div>
                                <button onClick={handleFinishWorkout} className="w-full bg-slate-800 text-white py-4 rounded-2xl font-black uppercase shadow-xl hover:bg-slate-900 active:scale-95 transition-transform flex items-center justify-center gap-2"><i data-lucide="check-circle" className="w-5 h-5"></i> Log Workout</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>